name: YG Playwright CI
on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Cache NPM modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # ğŸ”¹ Run tests with JSON reporter
      - name: Run Playwright tests
        run: npx playwright test || true
        continue-on-error: true

      # - name: Copy HTML report
      #   run: cp playwright-report/index.html playwright-report.html

      - name: Check workspace contents
        run: ls -la

      # ğŸ”¹ Parse test summary + test titles
      - name: Parse test summary from stats
        id: summary
        run: |
          # âœ… Get summary from .stats
          passed=$(jq '.stats.expected' results.json)
          failed=$(jq '.stats.unexpected' results.json)
          skipped=$(jq '.stats.skipped' results.json)
          flaky=$(jq '.stats.flaky' results.json)

          echo "âœ… Passed: $passed"
          echo "âŒ Failed: $failed"
          echo "âš ï¸ Skipped: $skipped"
          echo "ğŸ” Flaky: $flaky"

          # Export counts to GitHub Actions environment
          {
            echo "PASSED=$passed"
            echo "FAILED=$failed"
            echo "SKIPPED=$skipped"
            echo "FLAKY=$flaky"
          } >> $GITHUB_ENV

      # ğŸ”¹ Upload report (optional â€“ for debugging if needed)
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days:
            30

            # ğŸ”¹ Send Slack notification

      # ğŸ”¹ Send summary email
      - name: Send summary email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.GOOGLE_EMAIL }}
          password: ${{ secrets.GOOGLE_PASSWORD }}
          subject: "Test Results for ${{ github.repository }}"
          to: markchristiandurana75@gmail.com
          from: Playwright CI <mcdurana@jlabs.team>
          body: |
            âœ… Playwright test run completed for repository **${{ github.event.repository.name }}**

            ğŸ“Š Test Summary:
            -------------------------------------------------------------------
            âœ… Passed: ${{ env.PASSED }}
            âŒ Failed: ${{ env.FAILED }}
            âš ï¸ Skipped: ${{ env.SKIPPED }}
            ğŸ” Flaky: ${{ env.FLAKY }}
            -------------------------------------------------------------------

            ğŸ“ For more details, please see the attached **Playwright HTML report**.

            ğŸ“‘ How to open the Playwright HTML report:
              1. Download the attached file: `index.html`
              2. Open `index.html` in your browser (Chrome, Edge, Firefox, or Safari)

            ğŸ•µï¸ How to view Playwright trace files:
              1. Go to: **workflow artifacts** for this run:
                ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              2. Download the `playwright-report` artifact
              3. Inside, look for `test-results/trace-<hash>.zip`
              4. Open https://trace.playwright.dev
              5. Drag and drop a trace file into the viewer

            ğŸ”— Workflow Run:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            âœ‰ï¸ This email was sent automatically by GitHub Actions.

          attachments: playwright-report/index.html
